<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>App de Ex√°menes Clase B</title>
  <style>
    :root {
      --main-bg: #648aaf;
      --primary: #4b5563;
      --accent: #10b981;
      --text: #1f2937;
      --light: #ffffff;
      --danger: #ef4444;
      --border: #002266;
      --selected: #d1fae5;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--main-bg);
      color: var(--text);
      margin: 0;
      padding: 0;
    }
    header {
      background: var(--primary);
      color: var(--light);
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
    }
    nav {
      display: flex;
      justify-content: center;
      gap: 1rem;
      background: #224ca1;
      padding: 1rem;
    }
    nav button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.5rem;
      background: var(--accent);
      color: rgb(255, 255, 255);
      font-weight: bold;
      cursor: pointer;
    }
    nav button:hover {
      background: #059669;
    }
    .container {
      max-width: 900px;
      margin: auto;
      padding: 1rem;
    }
    section {
      background: var(--light);
      margin-bottom: 1.5rem;
      padding: 1rem;
      border-radius: 0.75rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    input, select, button.option-btn {
      display: block;
      width: 100%;
      margin: 0.5rem 0;
      padding: 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border);
    }
    button {
      background: var(--accent);
      color: rgb(0, 0, 0);
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #059669;
    }
    .question-box {
      border-bottom: 1px solid var(--border);
      padding: 1rem 0;
    }
    .correct {
      color: green;
    }
    .incorrect {
      color: red;
    }
    .hidden {
      display: none;
    }
    .delete-btn {
      background: var(--danger);
      margin-top: 0.5rem;
    }
    .option-btn {
      text-align: left;
      background: #b9b9b9;
      border: 1px solid var(--border);
    }
    .option-btn.selected {
      background: var(--selected);
      border: 2px solid var(--accent);
    }
    .info-bar {
      margin: 1rem 0;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>App para Ex√°menes</header>
  <nav>
    <button onclick="showSection('editor')">‚úèÔ∏è Editor</button>
    <button onclick="showSection('examen')">üß™ Examen</button>
    <button onclick="showSection('banco')">üìö Banco</button>
  </nav>

  <div class="container">
    <section id="editor">
      <h2>Editor de Preguntas</h2>
      <input type="file" id="importFile" accept="application/json">
      <button onclick="exportQuestions()">Exportar Preguntas</button>
      <button class="delete-btn" onclick="deleteAllQuestions()">üóëÔ∏è Borrar Todas las Preguntas</button>

      <h3>Nueva Pregunta</h3>
      <input type="text" id="newQuestion" placeholder="Escribe la pregunta...">
      <input type="text" id="optionA" placeholder="Opci√≥n A">
      <input type="text" id="optionB" placeholder="Opci√≥n B">
      <input type="text" id="optionC" placeholder="Opci√≥n C">
      <input type="text" id="optionD" placeholder="Opci√≥n D">
      <input type="text" id="correctAnswer" placeholder="Respuesta correcta (A/B/C/D)">
      <input type="text" id="imageUrl" placeholder="URL de imagen (opcional)">
      <button onclick="addQuestion()">Guardar Pregunta</button>
    </section>

    <section id="examen" class="hidden">
      <h2>Modo Examen</h2>
      <div class="info-bar" id="examInfo"></div>
      <button onclick="startExam()">Comenzar Examen</button>
      <div id="examContainer"></div>
    </section>

    <section id="banco" class="hidden">
      <h2>Banco de Preguntas</h2>
      <div id="questionList"></div>
    </section>
  </div>

  <script>
    let questions = JSON.parse(localStorage.getItem("questions") || "[]");

    function showSection(id) {
      document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }

    function saveQuestions() {
      localStorage.setItem("questions", JSON.stringify(questions));
      renderQuestionList();
    }

    function addQuestion() {
      const q = document.getElementById("newQuestion").value.trim();
      const a = document.getElementById("optionA").value.trim();
      const b = document.getElementById("optionB").value.trim();
      const c = document.getElementById("optionC").value.trim();
      const d = document.getElementById("optionD").value.trim();
      const correct = document.getElementById("correctAnswer").value.trim().toUpperCase();
      const image = document.getElementById("imageUrl").value.trim();
      if (!q || !a || !b || !c || !d || !["A","B","C","D"].includes(correct)) {
        alert("Por favor completa todos los campos correctamente");
        return;
      }
      questions.push({ question: q, options: { A: a, B: b, C: c, D: d }, correct: correct, image: image || null });
      saveQuestions();
      alert("Pregunta guardada ‚úÖ");
    }

    function convertOldFormat(item) {
      if (item.pregunta && Array.isArray(item.opciones) && typeof item.correcta === "number") {
        const letters = ["A", "B", "C", "D", "E", "F"];
        const options = {};
        for (let i = 0; i < item.opciones.length; i++) {
          options[letters[i]] = item.opciones[i];
        }
        return {
          question: item.pregunta,
          options: options,
          correct: letters[item.correcta],
          image: item.imagen || null
        };
      }
      return item;
    }

    document.getElementById("importFile").addEventListener("change", function(e) {
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          let newQuestions = JSON.parse(event.target.result);
          if (Array.isArray(newQuestions)) {
            newQuestions = newQuestions.map(convertOldFormat);
            questions = questions.concat(newQuestions);
            saveQuestions();
            alert("Preguntas importadas correctamente ‚úÖ");
          } else {
            alert("Formato de archivo no v√°lido");
          }
        } catch {
          alert("Error al leer el archivo JSON");
        }
      };
      reader.readAsText(e.target.files[0]);
    });

    function exportQuestions() {
      const blob = new Blob([JSON.stringify(questions, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "preguntas_clase_b.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function deleteAllQuestions() {
      if (confirm("¬øEst√°s seguro de que deseas borrar todas las preguntas?")) {
        questions = [];
        saveQuestions();
        alert("Todas las preguntas han sido eliminadas.");
      }
    }

    function deleteQuestion(index) {
      if (confirm("¬øBorrar esta pregunta?")) {
        questions.splice(index, 1);
        saveQuestions();
      }
    }

    let examTimer, timeLeft;
    function startExam() {
      const container = document.getElementById("examContainer");
      const info = document.getElementById("examInfo");
      clearInterval(examTimer);
      container.innerHTML = "";
      info.innerHTML = "";
      if (questions.length < 30) {
        container.innerHTML = "<p style='color: var(--danger);'>Se requieren al menos 30 preguntas para iniciar un examen.</p>";
        return;
      }
      const selected = [...questions].sort(() => 0.5 - Math.random()).slice(0, 30);
      let answers = new Array(30).fill(null);
      let start = Date.now();
      let duration = 45 * 60; // 45 minutos
      timeLeft = duration;

      function updateInfoBar() {
        const mins = Math.floor(timeLeft / 60);
        const secs = String(timeLeft % 60).padStart(2, "0");
        const answered = answers.filter(a => a !== null).length;
        info.textContent = `‚è±Ô∏è Tiempo restante: ${mins}:${secs} | Preguntas respondidas: ${answered}/30`;
        timeLeft--;
        if (timeLeft < 0) {
          clearInterval(examTimer);
          finishExam();
        }
      }

      updateInfoBar();
      examTimer = setInterval(updateInfoBar, 1000);

      selected.forEach((q, i) => {
        const div = document.createElement("div");
        div.className = "question-box";
        div.innerHTML = `<strong>${i + 1}. ${q.question}</strong><br>`;
        if (q.image) div.innerHTML += `<img src="${q.image}" style="max-width:100%;border-radius:0.5rem;margin-top:0.5rem;" /><br>`;
        for (const key in q.options) {
          const btn = document.createElement("button");
          btn.className = "option-btn";
          btn.textContent = `${key}) ${q.options[key]}`;
          btn.onclick = () => {
            const all = div.querySelectorAll(".option-btn");
            all.forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected");
            answers[i] = key;
            updateInfoBar();
          };
          div.appendChild(btn);
        }
        container.appendChild(div);
      });

      const btn = document.createElement("button");
      btn.textContent = "Finalizar Examen";
      btn.onclick = finishExam;
      container.appendChild(btn);

      function finishExam() {
        clearInterval(examTimer);
        let score = 0;
        container.innerHTML = "<h3>Resultado del Examen</h3>";
        selected.forEach((q, i) => {
          const div = document.createElement("div");
          div.className = "question-box";
          div.innerHTML = `<strong>${i + 1}. ${q.question}</strong><br>`;
          const userAns = answers[i] || "(sin respuesta)";
          div.innerHTML += `<p><strong>Tu respuesta:</strong> <span class="${userAns === q.correct ? 'correct' : 'incorrect'}">${userAns}</span></p>`;
          div.innerHTML += `<p><strong>Correcta:</strong> <span class="correct">${q.correct}) ${q.options[q.correct]}</span></p>`;
          container.appendChild(div);
          if (userAns === q.correct) score++;
        });
        container.innerHTML = `<h3>${score >= 21 ? '‚úÖ Aprobado' : '‚ùå Reprobado'} ‚Äî ${score}/30 correctas</h3>` + container.innerHTML;
      }
    }

    function renderQuestionList() {
      const list = document.getElementById("questionList");
      list.innerHTML = "";
      if (questions.length === 0) {
        list.innerHTML = "<p>No hay preguntas guardadas.</p>";
        return;
      }
      questions.forEach((q, i) => {
        const div = document.createElement("div");
        div.className = "question-box";
        div.innerHTML = `<strong>${i + 1}. ${q.question}</strong><br>`;
        if (q.image) div.innerHTML += `<img src="${q.image}" style="max-width:100%;border-radius:0.5rem;margin-top:0.5rem;" /><br>`;
        for (const key in q.options) {
          const correctClass = key === q.correct ? "correct" : "";
          div.innerHTML += `<p class='${correctClass}'><strong>${key}:</strong> ${q.options[key]}</p>`;
        }
        div.innerHTML += `<button class="delete-btn" onclick="deleteQuestion(${i})">üóëÔ∏è Borrar esta pregunta</button>`;
        list.appendChild(div);
      });
    }

    renderQuestionList();
  </script>
</body>
</html>
